%% Version: 1.2.0 (Aligned to Cluster Topology)
%% Authoritative Architecture for Gillsystems Cluster

flowchart TB
  %% Top-level Cluster Topology
  subgraph Cluster["Gillsystems Commander Cluster"]
    direction TB
    
    subgraph MainNode["Gillsystems-Main (10.0.0.164:8000)"]
        direction TB
        Commander[THE COMMANDER\nMeta-Orchestrator]
        SystemMgr[System Manager]
        RestAPI[REST API Interface]
    end

    subgraph StorageNode["HTPC (10.0.0.42:8001)"]
        direction TB
        Relay[Relay Server\nMessage Hub]
        subgraph ZFS["ZFS Dataset: /gillsystems_zfs_pool/AI_storage"]
            direction LR
            Memory[(Persistent Memory\nSQLite DB)]
            LogStore[Logs & Traceability]
            Artifacts[Artifact Registry]
            Checkpoints[Model Checkpoints]
        end
    end

    subgraph Workers["Worker Nodes (Decentralized Execution)"]
        direction LR
        Laptop["Laptop Node\n(10.0.0.93:8002)"]
        SteamDeck["Steam Deck Node\n(10.0.0.139:8003)"]
    end
  end

  %% Data & Control Flows
  User[User / Client] -->|Control Commands| RestAPI
  RestAPI --> SystemMgr
  SystemMgr --> Commander
  
  Commander -->|Assign Task| Relay
  Relay -->|Route Task| Workers
  
  Workers -->|Task Response| Relay
  Relay -->|Store Message| Memory
  Relay -->|Write Logs| LogStore
  
  Workers -.->|Read/Write Artifacts| Artifacts
  Commander -.->|Inject Context| Memory
  
  %% Style
  classDef primary fill:#003366,color:#fff,stroke:#0099cc,stroke-width:2px;
  classDef storage fill:#006633,color:#fff,stroke:#00cc66,stroke-width:2px;
  classDef worker fill:#444,color:#fff,stroke:#999,stroke-width:1px;
  
  class Commander,SystemMgr,RestAPI primary;
  class Relay,Memory,LogStore,Artifacts,Checkpoints,ZFS storage;
  class Laptop,SteamDeck worker;
